// Packages, city, booking, transport

model City {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  slug        String    @unique
  country     String    @default("India")
  description String?
  imageUrl    String?
  isActive    Boolean   @default(true)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  packages Package[]

  @@index([slug])
  @@index([isActive])
  @@index([deletedAt])
}

model Package {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  slug        String    @unique
  description String?
  summary     String?
  imageUrl    String?
  cityId      String?   @db.Uuid
  isActive    Boolean   @default(true)
  isFeatured  Boolean   @default(false)
  metaTitle   String?
  metaDesc    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  city         City?             @relation(fields: [cityId], references: [id], onDelete: SetNull)
  variants     PackageVariant[]
  itineraries  Itinerary[]
  schedules    PackageSchedule[]
  bookings     Booking[]
  reviews      Review[]

  @@index([slug])
  @@index([cityId])
  @@index([isActive, isFeatured])
  @@index([deletedAt])
}

model PackageVariant {
  id           String   @id @default(uuid()) @db.Uuid
  packageId    String   @db.Uuid
  name         String
  description  String?
  basePrice    Decimal  @db.Decimal(12, 2)
  currency     String   @default("INR")
  durationDays Int      @default(1)
  maxTravelers Int?
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  package Package  @relation(fields: [packageId], references: [id], onDelete: Cascade)
  addons  BookingAddon[] @relation("PackageVariantAddon")

  @@index([packageId])
}

model Itinerary {
  id          String   @id @default(uuid()) @db.Uuid
  packageId   String   @db.Uuid
  dayNumber   Int
  title       String
  description String?
  activities  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  package Package @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@unique([packageId, dayNumber])
  @@index([packageId])
}

model PackageSchedule {
  id              String   @id @default(uuid()) @db.Uuid
  packageId       String   @db.Uuid
  startDate       DateTime @db.Date
  endDate         DateTime @db.Date
  availableSeats  Int      @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  package  Package   @relation(fields: [packageId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@index([packageId])
  @@index([startDate, endDate])
}

model Booking {
  id                String        @id @default(uuid()) @db.Uuid
  userId            String        @db.Uuid
  packageId         String?       @db.Uuid
  packageScheduleId String?       @db.Uuid
  packageVariantId  String?       @db.Uuid
  status            BookingStatus @default(DRAFT)
  totalAmount       Decimal       @db.Decimal(12, 2)
  currency          String        @default("INR")
  couponId          String?       @db.Uuid
  discountAmount    Decimal       @default(0) @db.Decimal(12, 2)
  finalAmount       Decimal       @db.Decimal(12, 2)
  specialRequests   String?
  bookingStep       Int           @default(1)
  completedAt       DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  deletedAt         DateTime?

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  package         Package?          @relation(fields: [packageId], references: [id], onDelete: SetNull)
  packageSchedule PackageSchedule?  @relation(fields: [packageScheduleId], references: [id], onDelete: SetNull)
  coupon          Coupon?           @relation(fields: [couponId], references: [id], onDelete: SetNull)
  travelers       BookingTraveler[]
  addons          BookingAddon[]
  payments        Payment[]
  flightBooking   FlightBooking?
  trainBooking    TrainBooking?
  busBooking      BusBooking?

  @@index([userId])
  @@index([packageId])
  @@index([status])
  @@index([createdAt])
  @@index([deletedAt])
}

model BookingTraveler {
  id             String    @id @default(uuid()) @db.Uuid
  bookingId      String    @db.Uuid
  firstName      String
  lastName       String
  email          String?
  phone          String?
  dateOfBirth    DateTime? @db.Date
  passportNo     String?
  passportExpiry DateTime? @db.Date
  seatPreference String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
}

model BookingAddon {
  id               String   @id @default(uuid()) @db.Uuid
  bookingId        String   @db.Uuid
  packageVariantId String?  @db.Uuid
  name             String
  description      String?
  amount           Decimal  @db.Decimal(12, 2)
  quantity         Int      @default(1)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  booking        Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  packageVariant PackageVariant? @relation("PackageVariantAddon", fields: [packageVariantId], references: [id], onDelete: SetNull)

  @@index([bookingId])
}

model FlightBooking {
  id            String   @id @default(uuid()) @db.Uuid
  bookingId     String   @unique @db.Uuid
  airline       String
  flightNumber  String
  departureCity String
  arrivalCity   String
  departureAt   DateTime
  arrivalAt     DateTime
  seatNumber    String?
  pnr           String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
}

model TrainBooking {
  id            String   @id @default(uuid()) @db.Uuid
  bookingId     String   @unique @db.Uuid
  trainName     String
  trainNumber   String
  departureCity String
  arrivalCity   String
  departureAt   DateTime
  arrivalAt     DateTime
  coach         String?
  seatNumber    String?
  pnr           String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
}

model BusBooking {
  id            String   @id @default(uuid()) @db.Uuid
  bookingId     String   @unique @db.Uuid
  busOperator   String
  departureCity String
  arrivalCity   String
  departureAt   DateTime
  arrivalAt     DateTime
  seatNumber    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
}

model Coupon {
  id             String    @id @default(uuid()) @db.Uuid
  code           String    @unique
  description    String?
  discountType   String
  discountValue  Decimal   @db.Decimal(12, 2)
  minOrderAmount Decimal?  @db.Decimal(12, 2)
  maxDiscount    Decimal?  @db.Decimal(12, 2)
  usageLimit     Int?
  usedCount      Int       @default(0)
  validFrom      DateTime  @db.Date
  validTo        DateTime  @db.Date
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  usages    CouponUsage[]
  bookings Booking[]

  @@index([code])
  @@index([validFrom, validTo])
  @@index([deletedAt])
}

model CouponUsage {
  id             String   @id @default(uuid()) @db.Uuid
  couponId       String   @db.Uuid
  userId         String   @db.Uuid
  bookingId      String?  @db.Uuid
  discountAmount Decimal  @db.Decimal(12, 2)
  createdAt      DateTime @default(now())

  coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([couponId])
  @@index([userId])
}

model Review {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String    @db.Uuid
  packageId  String?   @db.Uuid
  rating     Int
  title      String?
  comment    String?
  isVerified Boolean   @default(false)
  isPublic   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  package Package? @relation(fields: [packageId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([packageId])
  @@index([rating])
  @@index([deletedAt])
}
